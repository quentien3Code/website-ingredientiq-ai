# nixpacks.toml
# Railway / Nixpacks: make the runtime deterministic.
# - We skip Nixpacks' auto Python dependency install.
# - We create our own venv at /opt/venv.
# - We install requirements.txt into that venv.
# - We run Django + Gunicorn explicitly from /opt/venv/bin.

[variables]
NIXPACKS_PYTHON_VERSION = "3.11"
NIXPACKS_PYTHON_PACKAGE_MANAGER = "skip"
PYTHONUNBUFFERED = "1"
PYTHONDONTWRITEBYTECODE = "1"

[phases.setup]
nixPkgs = [
  # Python runtime
  "python311",

  # Helpful for building any dependency that falls back to source
  "gcc",
  "pkg-config",

  # Common system libs needed by image/crypto stacks (safe + lightweight)
  "openssl",
  "libffi",
  "zlib",
  "libjpeg",
  "libpng",

  # If anything still touches OpenCV / GUI-linked libs at runtime
  "libGL",
  "libGLU",
  "glib"
]

# Ensure runtime can find shared libraries (libGL.so.1, etc.)
nixLibs = [
  "openssl",
  "libffi",
  "zlib",
  "libjpeg",
  "libpng",
  "libGL",
  "libGLU",
  "glib"
]

[phases.install]
cmds = [
  "python -m venv --copies /opt/venv",
  ". /opt/venv/bin/activate",
  "python -m pip install --upgrade pip",
  "pip install -r requirements.txt"
]

[start]
cmd = "/opt/venv/bin/python manage.py collectstatic --noinput && /opt/venv/bin/python manage.py migrate --noinput && /opt/venv/bin/gunicorn foodanalysis.wsgi:application --bind 0.0.0.0:$PORT"
